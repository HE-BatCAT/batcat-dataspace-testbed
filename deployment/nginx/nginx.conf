error_log /var/log/nginx/error.log debug;

${TOKEN_SERVICE_ENABLED}upstream token-service {
${TOKEN_SERVICE_ENABLED}    server $TOKEN_SERVICE_HOST;
${TOKEN_SERVICE_ENABLED}}

${UPLOAD_ENABLED}upstream tusd {
${UPLOAD_ENABLED}    server $TUSD_HOST;
${UPLOAD_ENABLED}}

${UPLOAD_ENABLED}upstream untus-proxy {
${UPLOAD_ENABLED}    server $UNTUS_PROXY_HOST;
${UPLOAD_ENABLED}}

${LINKAHEAD_ENABLED}upstream linkahead {
${LINKAHEAD_ENABLED}    server $LINKAHEAD_HOST;
${LINKAHEAD_ENABLED}}

${LINKAHEAD_ENABLED}upstream linkahead-webui {
${LINKAHEAD_ENABLED}    server $LINKAHEAD_WEBUI_HOST;
${LINKAHEAD_ENABLED}}

upstream connector-management {
    server $CONNECTOR_MANAGEMENT_HOST;
}

upstream connector-dsp {
    server $CONNECTOR_DSP_HOST;
}

${CONNECTOR_LIVENESS_ENABLED}upstream connector-liveness {
${CONNECTOR_LIVENESS_ENABLED}    server $CONNECTOR_LIVENESS_HOST;
${CONNECTOR_LIVENESS_ENABLED}}

# map to upload backends based on the Tus-Resumable header
${UPLOAD_ENABLED}map $http_tus_resumable $upload_backend {
${UPLOAD_ENABLED}     default "untus-proxy";
${UPLOAD_ENABLED}     "1.0.0" "tusd";
${UPLOAD_ENABLED}}

${DOWNLOAD_ENABLED}upstream public {
${DOWNLOAD_ENABLED}    server $CONNECTOR_PUBLIC_HOST;
${DOWNLOAD_ENABLED}}

log_format postdata $request_body;

server {

    listen 8000; # public port
    server_name 127.0.0.1, localhost

    charset     utf-8;
    server_tokens off;

    client_max_body_size 75M;

    location / {

        ${LINKAHEAD_ENABLED}location ${CAOSDB_CONFIG_CONTEXT_ROOT}/ {
        ${LINKAHEAD_ENABLED}    proxy_pass http://linkahead-webui${CAOSDB_CONFIG_CONTEXT_ROOT}/;
        ${LINKAHEAD_ENABLED}}

        location /control {
            access_log /var/log/nginx/error.log postdata;
            fastcgi_pass connector-dsp;
        }

        location /version {
            access_log /var/log/nginx/error.log postdata;
            fastcgi_pass connector-dsp;
        }

        location /api {
            access_log /var/log/nginx/error.log postdata;
            fastcgi_pass connector-dsp;
        }

        # general proxy settings
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Port $NGINX_PORT_PUBLIC;
        proxy_set_header Host $http_host;
        proxy_read_timeout 60s;
        proxy_redirect off;

        ${DOWNLOAD_ENABLED}location /public {
        ${DOWNLOAD_ENABLED}    proxy_pass http://public;
        ${DOWNLOAD_ENABLED}}

        location /dsp {
            proxy_pass http://connector-dsp;
        }

        ${TOKEN_SERVICE_ENABLED}location /keys {
        ${TOKEN_SERVICE_ENABLED}    proxy_pass http://token-service/keys;
        ${TOKEN_SERVICE_ENABLED}}

        ${UPLOAD_ENABLED}location /files {
            ${UPLOAD_ENABLED}${TOKEN_SERVICE_ENABLED}auth_request /_auth;

            ${UPLOAD_ENABLED}proxy_pass http://$upload_backend;
        ${UPLOAD_ENABLED}}

        ${TOKEN_SERVICE_ENABLED}location = /_auth {
            ${TOKEN_SERVICE_ENABLED}internal;

            ${TOKEN_SERVICE_ENABLED}proxy_method "GET";
            ${TOKEN_SERVICE_ENABLED}proxy_set_header Content-Length "";

            ${TOKEN_SERVICE_ENABLED}proxy_pass_request_body off;
            ${TOKEN_SERVICE_ENABLED}proxy_pass http://token-service/token;
        ${TOKEN_SERVICE_ENABLED}}
    }
}

server {
    listen 8001; ## private port
    server_name 127.0.0.1, localhost

    charset     utf-8;
    server_tokens off;

    client_max_body_size 75M;

    location / {

        # general proxy settings
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Port $NGINX_PORT_PRIVATE;
        proxy_set_header Host $http_host;
        proxy_read_timeout 60s;
        proxy_redirect off;

        ${LINKAHEAD_ENABLED}location ${CAOSDB_CONFIG_CONTEXT_ROOT}/ {
        ${LINKAHEAD_ENABLED}    proxy_pass http://linkahead${CAOSDB_CONFIG_CONTEXT_ROOT}/;
        ${LINKAHEAD_ENABLED}}

        location /management/v3 {
            ${TOKEN_SERVICE_ENABLED}auth_request /_auth;

            proxy_pass http://connector-management;
        }

        ${CONNECTOR_LIVENESS_ENABLED}location /api/check/liveness {

        ${CONNECTOR_LIVENESS_ENABLED}    proxy_pass http://connector-liveness;
        ${CONNECTOR_LIVENESS_ENABLED}}

        ${TOKEN_SERVICE_ENABLED}location /token {
        ${TOKEN_SERVICE_ENABLED}    proxy_pass http://token-service/token;
        ${TOKEN_SERVICE_ENABLED}}

        ${TOKEN_SERVICE_ENABLED}location /keys {
        ${TOKEN_SERVICE_ENABLED}    proxy_pass http://token-service/keys;
        ${TOKEN_SERVICE_ENABLED}}

        location /hello {
            ${TOKEN_SERVICE_ENABLED}auth_request /_auth;

            error_page 404 = @hello;
        }

        ${TOKEN_SERVICE_ENABLED}location = /_auth {

            ${TOKEN_SERVICE_ENABLED}internal;

            ${TOKEN_SERVICE_ENABLED}proxy_method "GET";
            ${TOKEN_SERVICE_ENABLED}proxy_set_header Content-Length "";

            ${TOKEN_SERVICE_ENABLED}proxy_pass_request_body off;
            ${TOKEN_SERVICE_ENABLED}proxy_pass http://token-service/token;
        ${TOKEN_SERVICE_ENABLED}}
    }


    location @hello {
        return 200 "Hello!";
    }


}
